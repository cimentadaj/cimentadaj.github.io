---
title: "What time should I ride my bike?"
author: "Jorge Cimentada"
date: '2018-02-12'
tags:
- R
- project
slug: what-time-should-i-ride-my-bike
---



<pre class="r"><code>library(DBI)
library(RMySQL)
library(caret)
library(tidyverse)

con &lt;- dbConnect(MySQL(),
                 dbname = &quot;bicing&quot;, # in &quot;&quot; quotes
                 host = &quot;82.196.1.229&quot;,
                 user = &quot;cimentadaj&quot;, # in &quot;&quot; quotes
                 password = rstudioapi::askForPassword())


query &lt;- glue::glue(
&quot;SELECT slots, bikes, status, time
 FROM bicing_station
 WHERE hour(time) IN (&#39;7&#39;, &#39;8&#39;, &#39;9&#39;, &#39;10&#39;, &#39;18&#39;, &#39;19&#39;, &#39;20&#39;)
 AND error_msg IS NULL;&quot;)

bicing &lt;-
  as_tibble(dbGetQuery(con, query)) %&gt;%
  mutate(time = lubridate::ymd_hms(time),
         slots = as.numeric(slots),
         bikes = as.numeric(slots))</code></pre>
<p>The station was always open.</p>
<pre class="r"><code>bicing %&gt;%
  filter(status != &quot;OPN&quot;)</code></pre>
<p>In the morning there seem’s to be more bikes than in the evening</p>
<pre class="r"><code>bicing %&gt;%
  mutate(hour = as.factor(lubridate::hour(time))) %&gt;%
  ggplot(aes(hour, bikes)) +
  geom_boxplot()</code></pre>
<p>Does this differ by day?</p>
<pre class="r"><code>bicing %&gt;%
  mutate(hour = lubridate::hour(time),
         day = lubridate::wday(time, label = TRUE),
         morning_evening = ifelse(hour &lt;= 10, &quot;Morning&quot;, &quot;Evening&quot;)) %&gt;%
  ggplot(aes(day, bikes, fill = morning_evening)) +
  geom_col(position = &quot;fill&quot;)</code></pre>
<p>There we can see the Friday effect</p>
<p>What’s the rate at which bicycles are being taken out by hour? At which time is the station emptying out quicker?</p>
<pre class="r"><code>intm_df &lt;-
  bicing %&gt;%
  mutate(hour = lubridate::hour(time)) %&gt;%
  group_by(hour) %&gt;%
  mutate(future_bike = lag(bikes)) %&gt;%
  summarize(avg_movement = mean(bikes != future_bike, na.rm = TRUE)) %&gt;%
  ungroup()</code></pre>
<p>Even though there are more bikes in the morning, bike activity is the same in th evening as in the early morning.</p>
<pre class="r"><code>intm_df &lt;-
  bicing %&gt;%
  mutate(hour = lubridate::hour(time),
         day = lubridate::wday(time, label = TRUE)) %&gt;%
  group_by(hour, day) %&gt;%
  mutate(future_bike = lag(bikes)) %&gt;%
  summarize(avg_movement = mean(bikes != future_bike, na.rm = TRUE)) %&gt;%
  ungroup()

intm_df %&gt;%
  top_n(10, avg_movement) %&gt;%
  unite(hour_day, hour, day, sep = &quot; - &quot;) %&gt;%
  ggplot(aes(hour_day, avg_movement)) +
  geom_col() +
  ylim(c(0, 1))</code></pre>
<p>Wednesdays at 9 AM seems to be the worst moment to pick/drop off a bike given that in 40% of the hour there’s movement. An interesting pattern is that most of the activity is concentrate on Wednesdays and Tuesdays and not only in the mornings.</p>
<p>When are the moments when the station is empty? When should I look for it?</p>
<pre class="r"><code>bicing %&gt;%
  filter(bikes == 0) %&gt;%
  count(hour = lubridate::hour(time), day = lubridate::wday(time, label = TRUE)) %&gt;%
  arrange(day, hour) %&gt;%
  ggplot(aes(hour, n)) +
  geom_col() +
  facet_wrap(~ day, ncol = 3)</code></pre>
<p>Bicing people probably prepare very well because it’s mostly empty in the evenings</p>
<p>Can I predict whether the station will be empty?</p>
<pre class="r"><code>empty_bicycle &lt;-
  mutate(bicing,
         empty = ifelse(bikes == 0, 1, 0),
         hour = as.character(lubridate::hour(time)),
         # morning = ifelse(time &lt;= 10, 1, 0),
         day = lubridate::wday(time),
         # weekend = ifelse(between(day, 6, 7), 1, 0),
         day = as.character(day)) %&gt;%
  select(-(1:4))

training_rows &lt;- createDataPartition(empty_bicycle$empty, 1, p = 0.8)[[1]]

training &lt;- empty_bicycle[training_rows, ]
test &lt;- empty_bicycle[-training_rows, ]

mod1 &lt;- glm(empty ~ . + day:hour, data = training, family = &quot;binomial&quot;)

pred1 &lt;- predict(mod1, newdata = test, type = &#39;response&#39;)

pred_empty &lt;- rbinom(length(pred1), 1, prob = pred1)

confusionMatrix(test$empty, pred_empty, positive = &quot;1&quot;)</code></pre>
<p>This model is terrible at predicting the emptyness of the stations.</p>
<p>A model is as good as the data that’s being fit.</p>
